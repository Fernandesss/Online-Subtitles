function findVideoTags(e){if(e){var n=0;findVideosOnPage=setInterval(function(){for(var e=document.getElementsByTagName("video"),t=0;t<e.length;t++)checkIfNotExists(e[t],allVideos)&&(e[t].src||findSource(e[t]))&&(n+=1,allVideos.push(e[t]),addOnlineSubLoadBtn(e[t],n))},1e3)}else{clearInterval(findVideosOnPage),clearInterval(setUpWrapPosTimer),clearTimeout(showTimeoutMM),clearTimeout(showTimeoutOW);for(var t=0;t<allVideos.length;t++)allVideos[t].removeEventListener("playing"),allVideos[t].removeEventListener("pause"),allVideos[t].removeEventListener("mousemove"),allVideos[t].removeEventListener("timeupdate"),allVideos=[]}}function findSource(e){return e.getElementsByTagName("source").length>0?!0:!1}function checkIfNotExists(e,n){for(var t=0;t<n.length;t++)if(e==n[t])return!1;return!0}function addOnlineSubLoadBtn(e,n){var t=[{fontName:"Arial",fontValue:"Arial, Helvetica, sans-serif"},{fontName:"Arial Black",fontValue:'"Arial Black", Gadget, sans-serif'},{fontName:"Impact",fontValue:"Impact, Charcoal, sans-serif"},{fontName:"Lucida Sans Unicode",fontValue:'"Lucida Sans Unicode", "Lucida Grande", sans-serif'},{fontName:"Tahoma",fontValue:"Tahoma, Geneva, sans-serif"},{fontName:"Trebuchet MS",fontValue:'"Trebuchet MS", Helvetica, sans-serif'},{fontName:"Verdana",fontValue:"Verdana, Geneva, sans-serif"},{fontName:"Georgia",fontValue:"Georgia, serif"},{fontName:"Palatino Linotype",fontValue:'"Palatino Linotype", "Book Antiqua", Palatino, serif'},{fontName:"Times New Roman",fontValue:'"Times New Roman", Times, serif'},{fontName:"Courier New",fontValue:'"Courier New", Courier, monospace'},{fontName:"Lucida Console",fontValue:'"Lucida Console", Monaco, monospace'}],a="<div class='onlineSubWrap'></div><div class='onlineSubDashboard'><input type='file' id='onlineSubLoadBtn"+n+"' accept='.srt' class='onlineSubLoadBtn'><label class='onlineSubLoadLabel' for='onlineSubLoadBtn"+n+"'><div></div></label><div class='onlineSubSettings' show='false'></div><br style='line-height: 30px;'><span>Adjust position: </span><input class='onlineSubRange' type='range' min='-1400' max='700' step='10' value='0'><br><span>Color: </span><input class='onlineSubColor' type='color' value='#ffff00'><span> Bold: </span><input class='onlineSubBold' type='checkbox'><br><span>Stroke: </span><input class='onlineSubStrokeColor' type='color' value='#000000'><br><span>Background color: </span><input class='onlineSubWrapLine' type='color' value='#000000'><br><span>Background opacity: </span><input class='onlineSubWrapLineOpacity' type='range' min='1' max='100' step='1' value='0'><br><span>Time corection (ms): </span><input class='onlineSubCorOutput' type='number' value='-1000'><br><span>Size: </span><input class='onlineSubFontSize' type='range' value='32' min='12' max='96' step='1'><br><span>Font family: </span><select class='onlineSubFontFamily'></select><br><span>Save global: </span><input type='button' value='save' class='onlineSubSaveAsGlobal'></div>";e.insertAdjacentHTML("afterend",a);var l=e.parentElement.getElementsByClassName("onlineSubWrap")[0],s=e.parentElement.getElementsByClassName("onlineSubWrapLine")[0],o=e.parentElement.getElementsByClassName("onlineSubLoadBtn")[0],r=e.parentElement.getElementsByClassName("onlineSubRange")[0],i=e.parentElement.getElementsByClassName("onlineSubColor")[0],u=e.parentElement.getElementsByClassName("onlineSubStrokeColor")[0],c=e.parentElement.getElementsByClassName("onlineSubFontSize")[0],m=e.parentElement.getElementsByClassName("onlineSubFontFamily")[0],p=e.parentElement.getElementsByClassName("onlineSubSettings")[0],a=e.parentElement.getElementsByClassName("onlineSubDashboard")[0],g=e.parentElement.getElementsByClassName("onlineSubWrapLineOpacity")[0],b=e.parentElement.getElementsByClassName("onlineSubSaveAsGlobal")[0],d=e.parentElement.getElementsByClassName("onlineSubBold")[0];setUpStyles(a,t,m,l),setUpWrapPos(e,l,r),getStylesFromStorage(a),p.addEventListener("click",showdashboard,!1),o.addEventListener("change",handleFileSelect,!1),c.addEventListener("input",changeFontSize,!1),g.addEventListener("input",changeSubOpacity,!1),i.addEventListener("change",changeSubColor,!1),u.addEventListener("change",changeSubStrokeColor,!1),s.addEventListener("change",changeSubWrapLine,!1),m.addEventListener("change",changeSubFontFamily,!1),e.addEventListener("playing",hideOnlineSubSettings,!1),e.addEventListener("pause",showOnlineSubSettings,!1),e.addEventListener("mousemove",showOnlineSubSettingsMM,!1),a.addEventListener("mousemove",showOnlineSubSettingsOW,!1),a.addEventListener("click",function(e){e.stopPropagation()},!1),b.addEventListener("click",saveStylesAsGlobal,!1),d.addEventListener("change",changeSubWeight,!1)}function changeSubWeight(e){var n=e.target.parentElement.parentElement.getElementsByClassName("onlineSubWrap")[0];e.target.checked?n.style.fontWeight="bold":n.style.fontWeight="normal"}function saveStylesAsGlobal(e){var n;n=void 0!==e.target?e.target.parentElement.parentElement.getElementsByClassName("onlineSubDashboard")[0]:e;for(var t=n.querySelectorAll("input[type='range'],input[type='checkbox'],input[type='color'],input[type='number'],select"),a=[],l=0;l<t.length;l++){var s={};s.className=t[l].className,"checkbox"===t[l].type?s.checked=t[l].checked:s.value=t[l].value,a.push(s)}saveStylesToStorage(a)}function getStylesFromStorage(e){chrome.storage.sync.get("onlineSubSettings",function(n){var t=e.querySelectorAll("input[type='range'],input[type='checkbox'],input[type='color'],input[type='number'],select");if(void 0!==n.onlineSubSettings)for(var a=0;a<t.length;a++)for(var l=0;l<n.onlineSubSettings.length;l++)t[a].className===n.onlineSubSettings[l].className&&("checkbox"===t[a].type?t[a].checked=n.onlineSubSettings[l].checked:t[a].value=n.onlineSubSettings[l].value,"onlineSubFontSize"===t[a].className||"onlineSubWrapLineOpacity"===t[a].className?t[a].dispatchEvent(new Event("input",{bubbles:!0})):t[a].dispatchEvent(new Event("change",{bubbles:!0})));else saveStylesAsGlobal(e)})}function saveStylesToStorage(e){chrome.storage.sync.set({onlineSubSettings:e},function(){chrome.runtime.sendMessage({changeGlobalSettings:e})})}function setUpStyles(e,n,t,a){for(var l=0;l<e.children.length;l++){var s=e.children[l].className;"onlineSubSettings"!=s&&"onlineSubLoadLabel"!=s&&(e.children[l].style.display="none")}for(var l=0;l<n.length;l++){var o=document.createElement("option");o.value=n[l].fontValue,o.innerText=n[l].fontName,t.appendChild(o)}}function setUpWrapPos(e,n,t){var a=parseInt(n.style.fontSize.slice(0,-2)),l=e.offsetHeight;setUpWrapPosTimer=setInterval(function(){a=parseInt(n.style.fontSize.slice(0,-2)),l=e.offsetHeight,n.style.top=l-3*a+parseInt(t.value)+"px"},500)}function showdashboard(e){var n=e.target.getAttribute("show"),t="none";"false"==n?(e.target.setAttribute("show","true"),t=""):e.target.setAttribute("show","false");for(var a=e.target.parentElement.children,l=0;l<a.length;l++){var s=a[l].className;"onlineSubSettings"!=s&&"onlineSubLoadLabel"!=s&&(a[l].style.display=t)}}function showOnlineSubSettingsOW(e){var n,t;"onlineSubDashboard"===e.target.className?(t=e.target.parentElement.getElementsByTagName("video")[0],n=e.target):(t=e.target.parentElement.parentElement.getElementsByTagName("video")[0],n=e.target.parentElement),void 0===t||t.paused||(clearTimeout(showTimeoutOW),n.style.opacity="1",showTimeoutOW=setTimeout(function(){clearTimeout(showTimeoutOW),n.style.opacity="0"},900))}function showOnlineSubSettingsMM(e){if(!e.target.paused){var n=e.target.parentElement.getElementsByClassName("onlineSubDashboard")[0];clearTimeout(showTimeoutMM),n&&(n.style.opacity="1"),showTimeoutMM=setTimeout(function(){clearTimeout(showTimeoutMM),n&&(n.style.opacity="0")},900)}}function hideOnlineSubSettings(e){var n=e.target.parentElement.getElementsByClassName("onlineSubDashboard")[0];setTimeout(function(){n&&(n.style.opacity="0")},1e3)}function showOnlineSubSettings(e){var n=e.target.parentElement.getElementsByClassName("onlineSubDashboard")[0];setTimeout(function(){n&&(n.style.opacity="1")},1100)}function changeSubFontFamily(e){var n=e.target.parentElement.parentElement.getElementsByClassName("onlineSubWrap")[0];n.style.fontFamily=e.target.value}function changeFontSize(e){var n=e.target.parentElement.parentElement.getElementsByClassName("onlineSubWrap")[0];n.style.fontSize=e.target.value+"px"}function changeSubWrapLine(e){e.target.parentElement.getElementsByClassName("style").length>0&&e.target.parentElement.removeChild(e.target.parentElement.getElementsByClassName("style")[0]);var n=(e.target.parentElement.parentElement.getElementsByClassName("onlineSubWrap")[0].getElementsByTagName("span"),parseInt(e.target.parentElement.getElementsByClassName("onlineSubWrapLineOpacity")[0].value)),t=document.createElement("style");t.type="text/css",t.innerHTML=".onlineSubWrap span{background-color: "+convertHex(e.target.value,n)+";}",e.target.parentElement.appendChild(t)}function changeSubOpacity(e){e.target.parentElement.getElementsByClassName("style").length>0&&e.target.parentElement.removeChild(e.target.parentElement.getElementsByTagName("style")[0]);var n=e.target.parentElement.parentElement.getElementsByClassName("onlineSubWrap")[0].getElementsByTagName("span"),n=e.target.parentElement.getElementsByClassName("onlineSubWrapLine")[0].value,t=document.createElement("style");t.type="text/css",t.innerHTML=".onlineSubWrap span{background-color: "+convertHex(n,e.target.value)+";}",e.target.parentElement.appendChild(t)}function convertHex(e,n){return e=e.replace("#",""),r=parseInt(e.substring(0,2),16),g=parseInt(e.substring(2,4),16),b=parseInt(e.substring(4,6),16),result="rgba("+r+","+g+","+b+","+n/100+")",result}function changeSubColor(e){var n=e.target.parentElement.parentElement.getElementsByClassName("onlineSubWrap")[0];n.style.webkitTextFillColor=e.target.value}function changeSubStrokeColor(e){var n=e.target.parentElement.parentElement.getElementsByClassName("onlineSubWrap")[0];n.style.webkitTextStrokeColor=e.target.value}function handleFileSelect(e){var n=this,t=n.parentElement.parentElement.getElementsByTagName("video")[0],a=n.parentElement.parentElement.getElementsByClassName("onlineSubWrap")[0];if(n.files&&n.files[0]){var l=n.files[0],s=new FileReader;s.onload=function(e){return function(e){var l=!1;try{var s=parseSrt(e.target.result)}catch(e){alert("reading the file error"),l=!0}l||startVideoListner(t,a,n,s)}}(l),s.readAsText(l)}}function parseSrt(e){for(var n=e.trim().split(-1!=e.search("\n\r\n")?"\n\r\n":"\n\n"),t=[],a=0;a<n.length;a++){var l={},s=n[a].split("\n"),o=s[1].split(" --> ");l.number=parseInt(s[0],10),l.startTime=parseTime(o[0]),l.endTime=parseTime(o[1]),s.length>3?l.text=s.slice(2).join("\n"):l.text=s[2],t.push(l)}return t}function parseTime(e){var n=e.split(":"),t=n[2].split(","),a=parseInt(n[0],10),l=parseInt(n[1],10),s=parseInt(t[0],10),o=parseInt(t[1],10);return 1e3*(3600*a+60*l+s)+o}function getVideoCurTime(e){var n=e.currentTime.toString().split(".");return n.length<=1?n[0]:1e3*n[0]+parseInt(n[1].slice(0,3))}function startVideoListner(e,n,t,a){e.addEventListener("timeupdate",function(){var t=getVideoCurTime(e);curSubText=sybSynch(e,t,a),curSubText=curSubText.split("\n");for(var l="",s=0;s<curSubText.length;s++)l+="<span>"+curSubText[s]+"</span><br>";n.innerHTML=l},!1)}function sybSynch(e,n,t){for(var a=parseInt(e.parentElement.getElementsByClassName("onlineSubCorOutput")[0].value),l=0,s="",o=0;o<t.length;o++)n>=t[o].startTime+a&&n<=t[o].endTime+a&&(s=t[o].text,l=t[o].endTime);return n>=l+a&&(s=" "),s}function checkIfNotBannedGlobal(){var e=!0,n=!0;chrome.storage.sync.get("onlineSub",function(t){if(void 0!==t.onlineSub){var a=extractDomain(window.location.href);e=t.onlineSub,chrome.storage.sync.get("onlineSubOnPage",function(t){if(void 0!==t.onlineSubOnPage)for(var l=0;l<t.onlineSubOnPage.length;l++)t.onlineSubOnPage[l]===a&&(n=!1);findVideoTags(e&&n?!0:!1)})}})}function extractDomain(e){var n;return n=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0],n=n.split(":")[0]}function setStylesFromGlobal(e){for(var n=document.getElementsByClassName("onlineSubDashboard"),t=0;t<n.length;t++){var a=n[t].querySelectorAll("input[type='range'],input[type='checkbox'],input[type='color'],input[type='number'],select");if(e.length>0)for(var l=0;l<a.length;l++)for(var s=0;s<e.length;s++)a[l].className===e[s].className&&("checkbox"===a[l].type?a[l].checked=e[s].checked:a[l].value=e[s].value,"onlineSubFontSize"===a[l].className||"onlineSubWrapLineOpacity"===a[l].className?a[l].dispatchEvent(new Event("input",{bubbles:!0})):a[l].dispatchEvent(new Event("change",{bubbles:!0})))}}function removeOnlineSub(){for(var e=document.getElementsByClassName("onlineSubWrap"),n=document.getElementsByClassName("onlineSubDashboard"),t=0;t<e.length;t++)e[t].remove();for(var t=0;t<n.length;t++)n[t].remove()}var findVideosOnPage=null,allVideos=[],setUpWrapPosTimer=null,showTimeoutOW=null,showTimeoutMM=null;chrome.runtime.onMessage.addListener(function(e,n,t){"onlineSubOff"===e.onlineSub?(checkIfNotBannedGlobal(),removeOnlineSub()):"onlineSubOn"===e.onlineSub?checkIfNotBannedGlobal():void 0!==e.changeGlobalSettings&&setStylesFromGlobal(e.changeGlobalSettings)}),checkIfNotBannedGlobal();